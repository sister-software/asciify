<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Asciify Three.js Demo</title>

    <style>
      @media (prefers-color-scheme: dark) {
        body {
          background-color: #000;
          color: #fff;
        }
      }

      * {
        box-sizing: border-box;
      }
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell,
          'Open Sans', 'Helvetica Neue', sans-serif;
        margin: 0;
        padding: 0;
      }
    </style>

    <script type="importmap">
      {
        "imports": {
          "stats": "/node_modules/stats-js/src/Stats.js",
          "three": "/node_modules/three/build/three.module.js",
          "three/addons/": "/node_modules/three/examples/jsm/"
        }
      }
    </script>

    <script type="module">
      import { Asciify } from '/dist/mod.mjs'
      import Stats from 'stats'
      import * as THREE from 'three'
      import { VertexNormalsHelper } from 'three/addons/helpers/VertexNormalsHelper.js'
      import { VertexTangentsHelper } from 'three/addons/helpers/VertexTangentsHelper.js'
      import { OrbitControls } from 'three/addons/controls/OrbitControls.js'

      const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 4000)
      camera.position.y = 800
      camera.position.x = -1200
      camera.position.z = 201

      const scene = new THREE.Scene()
      scene.background = new THREE.Color('hsl(0, 0%, 20%)')

      const pointLight1 = new THREE.PointLight(0xffffff, 0.5)
      pointLight1.position.set(500, 500, 500)
      scene.add(pointLight1)

      const pointLight2 = new THREE.PointLight(0xffffff, 0.25)
      pointLight2.position.set(-500, -500, -500)
      scene.add(pointLight2)

      const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444)
      hemiLight.position.set(0, 200, 0)
      scene.add(hemiLight)

      const ambientLight = new THREE.AmbientLight(0x404040)
      scene.add(ambientLight)

      const sphere = new THREE.Mesh(
        new THREE.SphereGeometry(200, 20, 10),
        new THREE.MeshPhongMaterial({ flatShading: true })
      )

      sphere.material.color.setHSL(0.9, 0.8, 0.8)
      scene.add(sphere)

      const ground = new THREE.Mesh(
        new THREE.PlaneGeometry(2000, 2000),
        new THREE.MeshPhongMaterial({ color: 0x999999, depthWrite: false })
      )
      ground.position.y = -200
      ground.rotation.x = -Math.PI / 2

      scene.add(ground)

      const grid = new THREE.GridHelper(2000, 20, 0x0000ff, 0xff0000)
      grid.position.y = -199
      grid.material.opacity = 0.2
      grid.material.transparent = true
      scene.add(grid)

      const startTime = Date.now()
      const renderer = new THREE.WebGLRenderer({
        powerPreference: 'high-performance',
        precision: 'highp',
      })

      const threeContext = renderer.getContext()

      const asciiOptionsForm = document.getElementById('ascii-options')
      const canvas = document.getElementById('demo')
      const asciify = new Asciify(canvas, Object.fromEntries(new FormData(asciiOptionsForm)))

      // Expose asciify to the window for debugging
      window.asciify = asciify
      // document.body.appendChild(renderer.domElement)

      asciify.setSize(canvas.clientWidth, canvas.clientHeight, renderer)
      // camera.aspect = canvas.clientWidth / canvas.clientHeight
      // Controls
      const controls = new OrbitControls(camera, asciify.domElement)

      const sphereColorPicker = document.getElementById('sphere-hue')

      sphereColorPicker.addEventListener('input', (event) => {
        sphere.material.color.setHSL(event.target.value, 0.8, 0.8)
      })

      asciiOptionsForm.addEventListener('change', (event) => {
        asciify.setOptions({ [event.target.name]: event.target.value })
        asciify.resize(renderer)
      })

      // Resize
      const onWindowResize = () => {
        asciify.setSize(window.innerWidth, window.innerHeight, renderer)

        camera.aspect = window.innerWidth / window.innerHeight
        camera.updateProjectionMatrix()
      }

      window.addEventListener('resize', onWindowResize)

      const stats = new Stats()
      stats.dom.style.left = 'auto'
      stats.dom.style.top = 'auto'
      stats.dom.style.right = '0'
      stats.dom.style.bottom = '0'
      stats.showPanel(0)
      document.body.appendChild(stats.dom)
      // Animation
      let animationFrame = -1
      const animate = () => {
        stats.begin()
        const timer = Date.now() - startTime

        sphere.position.y = Math.abs(Math.sin(timer * 0.003)) * 250
        sphere.rotation.x = timer * 0.0009
        sphere.rotation.z = timer * 0.0008

        controls.update()

        renderer.render(scene, camera)
        asciify.rasterizeThree(renderer)
        stats.end()
        animationFrame = requestAnimationFrame(animate)
      }

      animate()
    </script>
  </head>
  <body>
    <h1>Asciify</h1>

    <form id="ascii-options">
      <legend>Asciify Options</legend>

      <fieldset>
        <label for="font-size">Font Size</label>
        <input id="font-size" name="fontSize" type="number" value="10" min="5" max="25" step="1" />
      </fieldset>

      <fieldset>
        <label for="line-height">Line Height</label>
        <input id="line-height" name="lineHeight" type="number" value="1" min="0.5" max="3" step="0.1" />
      </fieldset>

      <fieldset>
        <legend>Render Mode</legend>
        <div>
          <label for="font-size">Color</label>
          <input type="radio" name="mode" value="color" />
        </div>
        <div>
          <label for="font-size">Block</label>
          <input type="radio" name="mode" value="block" checked />
        </div>

        <div>
          <label for="font-size">Grayscale</label>
          <input type="radio" name="mode" value="grayscale" />
        </div>
      </fieldset>
    </form>

    <form>
      <legend>Three.js Options</legend>

      <fieldset>
        <label for="sphere-hue">Sphere color</label>
        <input id="sphere-hue" type="range" value="0.9" min="0" max="1" step="0.01" />
      </fieldset>
    </form>

    <canvas id="demo" style="width: 100%; height: 100%"></canvas>
  </body>
</html>
